---
title: "[React] useSyncExternalStoreã§ä½œã‚‹ã‚ªãƒ¬ã‚ªãƒ¬Stateãƒ©ã‚¤ãƒ–ãƒ©ãƒª"
emoji: "ğŸ«"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [nextjs, typescript, react, javascript]
published: false
---

# ã‚ã¾ã‚Šè©±é¡Œã«ã•ã‚Œãªã„ useSyncExternalStore

ReactHooks è§£èª¬ç³»ã®è¨˜äº‹ã§ç„¡ã‹ã£ãŸã“ã¨ã«ã•ã‚ŒãŸã‚Šã€ä¸€ç¬ã ã‘æ¦‚è¦ãŒç´¹ä»‹ã•ã‚Œã‚‹ã ã‘ãªã“ã¨ãŒå¤šã„ useSyncExternalStore ã§ã™ã€‚å¯å“€æƒ³ãªã®ã§ã€ã‚ªãƒ¬ã‚ªãƒ¬ State ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½œã£ã¦ä½¿ã„æ–¹ã‚’ç´¹ä»‹ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

# ã‚ªãƒ¬ã‚ªãƒ¬ State ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯ä¸€ç¬ã§æ§‹ç¯‰ã§ãã‚‹

```ts
import { useRef, useSyncExternalStore } from "react";

export type ContextType<T> = {
  state: T;
  storeChanges: Set<() => void>;
  dispatch: (callback: (state: T) => T) => void;
  subscribe: (onStoreChange: () => void) => () => void;
};

export const createStoreContext = <T>(initState: () => T) => {
  const context = useRef<ContextType<T>>({
    state: initState(),
    storeChanges: new Set(),
    dispatch: (callback) => {
      context.state = callback(context.state);
      context.storeChanges.forEach((storeChange) => storeChange());
    },
    subscribe: (onStoreChange) => {
      context.storeChanges.add(onStoreChange);
      return () => {
        context.storeChanges.delete(onStoreChange);
      };
    },
  }).current;
  return context;
};

export const useSelector = <T, R>(
  context: ContextType<T>,
  getSnapshot: (state: T) => R
) =>
  useSyncExternalStore(
    context.subscribe,
    () => getSnapshot(context.state),
    () => getSnapshot(context.state)
  );
```

ã¯ã„ã€å‡ºæ¥ä¸ŠãŒã‚Šã§ã™ã€‚ã“ã‚Œã ã‘ã§ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã® State ã®æ›´æ–°ã‚’è‡ªç”±è‡ªåœ¨ã«æ“ã‚Œã¾ã™ã€‚ã§ã¯ã€ä½¿ã„æ–¹ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```tsx
type StateType = { a: number; b: number; c: number };

const A = ({ context }: { context: ContextType<StateType> }) => {
  const value = useSelector(context, (state) => state.a);
  return <div>A:{value}</div>;
};
const B = ({ context }: { context: ContextType<StateType> }) => {
  const value = useSelector(context, (state) => state.b);
  return <div>B:{value}</div>;
};
const C = ({ context }: { context: ContextType<StateType> }) => {
  const value = useSelector(context, (state) => state.c);
  return <div>C:{value}</div>;
};

const Buttons = ({ context }: { context: ContextType<StateType> }) => {
  return (
    <div>
      <button
        onClick={() =>
          context.dispatch((state) => ({ ...state, a: state.a + 1 }))
        }
      >
        A
      </button>
      <button
        onClick={() =>
          context.dispatch((state) => ({ ...state, b: state.b + 1 }))
        }
      >
        B
      </button>
      <button
        onClick={() =>
          context.dispatch((state) => ({ ...state, c: state.c + 1 }))
        }
      >
        C
      </button>
    </div>
  );
};

const Page = () => {
  const context = createStoreContext<StateType>(() => ({
    a: 0,
    b: 10,
    c: 100,
  }));
  return (
    <div>
      <A context={context} />
      <B context={context} />
      <C context={context} />
      <Buttons context={context} />
    </div>
  );
};
```

ã“ã‚Œã§å…±æœ‰ã•ã‚Œã¦ã„ã‚‹ State ã®å†…ã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒå¿…è¦ã¨ã™ã‚‹éƒ¨åˆ†ãŒæ›´æ–°ã•ã‚ŒãŸå ´åˆã®ã¿ã€æœ€å°é™ã§å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

![](/images/fd99b000aa57f0/2023-04-18-17-20-04.gif)

# Context ã‚’é…ã‚‹ã®ãŒé¢å€’ãªå ´åˆ

`createContext`ã‚’ä½¿ã£ã¦ Provider ã‚’ä½œã‚Šã€é…ä¸‹ã« Context ã‚’é…ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

```tsx
import {
  useRef,
  useSyncExternalStore,
  createContext,
  ReactNode,
  useContext,
} from "react";

export type ContextType<T> = {
  state: T;
  storeChanges: Set<() => void>;
  dispatch: (callback: (state: T) => T) => void;
  subscribe: (onStoreChange: () => void) => () => void;
};

export const createStoreContext = <T,>(initState: () => T) => {
  const context = useRef<ContextType<T>>({
    state: initState(),
    storeChanges: new Set(),
    dispatch: (callback) => {
      context.state = callback(context.state);
      context.storeChanges.forEach((storeChange) => storeChange());
    },
    subscribe: (onStoreChange) => {
      context.storeChanges.add(onStoreChange);
      return () => {
        context.storeChanges.delete(onStoreChange);
      };
    },
  }).current;
  return context;
};

const StoreContext = createContext<ContextType<any>>(undefined as never);

export const StoreProvider = <T,>({
  children,
  initState,
}: {
  children: ReactNode;
  initState: () => T;
}) => {
  const context = createStoreContext(initState);
  return (
    <StoreContext.Provider value={context}>{children}</StoreContext.Provider>
  );
};

export const useSelector = <T, R>(getSnapshot: (state: T) => R) => {
  const context = useContext<ContextType<T>>(StoreContext);
  return useSyncExternalStore(
    context.subscribe,
    () => getSnapshot(context.state),
    () => getSnapshot(context.state)
  );
};

export const useDispatch = <T,>() => {
  const context = useContext<ContextType<T>>(StoreContext);
  return context.dispatch;
};
```

ä½¿ã„æ–¹ã¯ã“ã‚“ãªå½¢ã§ã™ã€‚

```tsx
type StateType = { a: number; b: number; c: number };

const A = () => {
  const value = useSelector((state: StateType) => state.a);
  return <div>A:{value}</div>;
};
const B = () => {
  const value = useSelector((state: StateType) => state.b);
  return <div>B:{value}</div>;
};
const C = () => {
  const value = useSelector((state: StateType) => state.c);
  return <div>C:{value}</div>;
};

const Buttons = () => {
  const dispatch = useDispatch<StateType>();
  return (
    <div>
      <button
        onClick={() => dispatch((state) => ({ ...state, a: state.a + 1 }))}
      >
        A
      </button>
      <button
        onClick={() => dispatch((state) => ({ ...state, b: state.b + 1 }))}
      >
        B
      </button>
      <button
        onClick={() => dispatch((state) => ({ ...state, c: state.c + 1 }))}
      >
        C
      </button>
    </div>
  );
};

const Page = () => {
  return (
    <StoreProvider
      initState={() => ({
        a: 0,
        b: 10,
        c: 100,
      })}
    >
      <A />
      <B />
      <C />
      <Buttons />
    </StoreProvider>
  );
};
export default Page;
```

Context ã‚’é…ã‚‹å¿…è¦ãŒç„¡ããªã‚Šã€ã‚³ãƒ¼ãƒ‰é‡ãŒå°‘ãªããªã‚Šã¾ã—ãŸã€‚

# useSyncExternalStore ã‚’ä½¿ã‚ãšã«åŒã˜äº‹ã‚’ã—ã¦ã¿ã‚‹

å®Ÿã¯`useState`ã® dispatch ã‚’åé›†ã™ã‚‹æ§‹é€ ã‚’ä½œã‚‹ã ã‘ã§ã€`useSyncExternalStore`ã¨åŒã˜äº‹ãŒå¯èƒ½ã§ã™ã€‚ã‚³ãƒ¼ãƒ‰é‡ã®ã»ã¨ã‚“ã©åŒã˜ã§ã™ã€‚

```tsx
import {
  useRef,
  createContext,
  ReactNode,
  useContext,
  useState,
  Dispatch,
  SetStateAction,
  useEffect,
} from "react";

type ContextType<T> = {
  state: T;
  storeChanges: Map<Dispatch<SetStateAction<any>>, (state: T) => unknown>;
  dispatch: (callback: (state: T) => T) => void;
};

const createStoreContext = <T,>(initState: () => T) => {
  const context = useRef<ContextType<T>>({
    state: initState(),
    storeChanges: new Map(),
    dispatch: (callback) => {
      context.state = callback(context.state);
      context.storeChanges.forEach((callback, storeChange) =>
        storeChange(callback(context.state))
      );
    },
  }).current;
  return context;
};

const StoreContext = createContext<ContextType<any>>(undefined as never);

const StoreProvider = <T,>({
  children,
  initState,
}: {
  children: ReactNode;
  initState: () => T;
}) => {
  const context = createStoreContext(initState);
  return (
    <StoreContext.Provider value={context}>{children}</StoreContext.Provider>
  );
};

const useSelector = <T, R>(getSnapshot: (state: T) => R) => {
  const context = useContext<ContextType<T>>(StoreContext);
  const [state, dispatch] = useState(() => getSnapshot(context.state));
  context.storeChanges.set(dispatch, getSnapshot);
  useEffect(() => {
    context.storeChanges.set(dispatch, getSnapshot);
    return () => {
      context.storeChanges.delete(dispatch);
    };
  }, [context, getSnapshot]);
  return state;
};

const useDispatch = <T,>() => {
  const context = useContext<ContextType<T>>(StoreContext);
  return context.dispatch;
};
```

ä½¿ã„æ–¹ã‚‚å‰ã®ã‚µãƒ³ãƒ—ãƒ«ã¨åŒã˜ã§ã™ã€‚

# ã¾ã¨ã‚

State ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½œã‚‹ã¨ãã¯å…¬å¼ã§`useSyncExternalStore`ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã‚‹ã®ã§å¿…è¦ã¨ã‚ã‚‰ã°ä½¿ã†ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ãŒã€ã¶ã£ã¡ã‚ƒã‘ç„¡ãã¦ã‚‚ä½•ã«ã‚‚å›°ã‚Šã¾ã›ã‚“ã€‚

`useSyncExternalStore`ã®ä½¿ã„é“ã¨ã—ã¦ã¯å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å…¥ã‚Œã‚‹ã»ã©ã§ã‚‚ç„¡ã„ã‘ã‚Œã©ã€å±€åœ°çš„ã«å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹å ´æ‰€ã‚’èª¿æ•´ã—ãŸã„å ´åˆãªã©ã«ä½¿ã†ã¨è‰¯ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
