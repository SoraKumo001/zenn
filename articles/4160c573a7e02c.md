---
title: "NestJSã¨@apollo/server(v4ç³»)ã«ã‚ˆã‚‹GraphQLã®å®Ÿè£…"
emoji: "ğŸ’­"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [nestjs, typescript, apollo, graphql]
published: true
---

# ApolloServer3 ã®ã‚µãƒãƒ¼ãƒˆçµ‚äº†ã¯ 2023/10/22

2023/1/27 ç¾åœ¨ã€NestJS ã®[å…¬å¼ãƒšãƒ¼ã‚¸](https://docs.nestjs.com/graphql/quick-start)ã«è¼‰ã£ã¦ã„ã‚‹æ–¹æ³•ã‚‚éæ¨å¥¨ã® 3 ç³»çµ±ã‚’ä½¿ã†æ–¹æ³•ã¨ãªã£ã¦ã„ã¾ã™ã€‚[apollo-server-express](https://www.npmjs.com/package/apollo-server-express)ã¯éæ¨å¥¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ã™ã€‚æ—©ã€…ã«`Apollo Server 4`ã«ç§»è¡Œã—ã¾ã—ã‚‡ã†ã€‚

Next.js ç‰ˆã®è¨˜äº‹ã¯[ã“ã¡ã‚‰](https://zenn.dev/sora_kumo/articles/bfc2fcdc9b7710)ã§ã™ã€‚

ä»¥ä¸‹å…¬å¼ã‚µã‚¤ãƒˆã«`Apollo Server 3`ã®çµ‚äº†ã¨ã€`Apollo Server 4` ç§»è¡Œã‚’ãŠå‹§ã‚ã™ã‚‹èª¬æ˜ãŒè¼‰ã£ã¦ã„ã¾ã™ã€‚

https://www.apollographql.com/docs/apollo-server/migration

# ç§»è¡Œã«å‚™ãˆã¦

NestJS ã§`Apollo Server 4`ã‚’æœ€å°ã®åŠ´åŠ›ã§ä½¿ã†ã«ã¯ã€controller ã‹ã‚‰å¿…è¦ãªæƒ…å ±ã‚’æ¸¡ã—ã¦å‘¼ã³å‡ºã™ã ã‘ã§ OK ã§ã™ã€‚ã¨ã„ã†ã“ã¨ã§ã‚„ã‚Šæ–¹ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

# ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ä½œæˆ

## NestJS ã®åŸºæœ¬ç’°å¢ƒä½œæˆ

- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ
  `nest n ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå`

- ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ç§»å‹•
  `cd ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå`

- å¿…è¦ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®è¿½åŠ 
  `yarn add @apollo/server @node-libraries/nest-apollo-server graphql graphql-tag`

- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã®è¿½åŠ 
  `nest g co graphql`

ã“ã“ã¾ã§ã§ã€`Apollo Server 4`ã‚’ NestJS ã«å®Ÿè£…ã™ã‚‹æº–å‚™ã¯å®Œäº†ã§ã™ã€‚

## ã‚³ãƒ¼ãƒ‰ã®ä¿®æ­£

### bodyParser ã®ç„¡åŠ¹åŒ–

#### src/main.js

åˆæœŸã‚³ãƒ¼ãƒ‰ã«å¯¾ã—ã¦`bodyParser`ã‚’ç„¡åŠ¹ã«ã™ã‚‹è¨­å®šã‚’å…¥ã‚Œã¾ã™ã€‚Fastify ã®æ–¹ãŒç„¡åŠ¹åŒ–ãŒé¢å€’ã§ã™ã€‚

- Express

```ts
import { NestFactory } from "@nestjs/core";
import { AppModule } from "./app.module";

async function bootstrap() {
  const app = await NestFactory.create(AppModule, {
    bodyParser: false,
  });
  await app.listen(3000);
  console.log("http://localhost:3000/graphql");
}
bootstrap();
```

- Fastify

```ts
import { NestFactory } from "@nestjs/core";
import { AppModule } from "./app.module";
import {
  FastifyAdapter,
  NestFastifyApplication,
} from "@nestjs/platform-fastify";

async function bootstrap() {
  const fastifyAdapter = new FastifyAdapter();
  fastifyAdapter.getInstance().removeAllContentTypeParsers();
  fastifyAdapter
    .getInstance()
    .addContentTypeParser("*", { bodyLimit: 0 }, (_request, _payload, done) => {
      done(null, null);
    });
  const app = await NestFactory.create<NestFastifyApplication>(
    AppModule,
    fastifyAdapter,
    {
      bodyParser: false,
    }
  );
  await app.listen(3000);
  console.log("http://localhost:3000/graphql");
}
bootstrap();
```

### controller ã‹ã‚‰`Apollo Server 4`ã‚’å‘¼ã³å‡ºã™

#### src/graphql/graphql.controller.ts

`nest g co graphql`ã§ä½œã£ãŸåˆæœŸã‚³ãƒ¼ãƒ‰ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ãæ›ãˆã¾ã™ã€‚Controller ã«ã¹ãŸæ›¸ãã—ã¦ã„ã¾ã™ãŒã€æ©Ÿèƒ½ã‚’ Service ã¸ç§»å‹•ã•ã›ãŸã‚Šã™ã‚‹ã®ã¯çŠ¶æ³ã«åˆã‚ã›ã¦è¡Œã£ã¦ãã ã•ã„ã€‚

`scalar Upload`ã«ã‚ˆã‚‹ãƒã‚¤ãƒŠãƒªã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã«ã‚‚å¯¾å¿œã•ã›ã¦ã‚ã‚Šã¾ã™ã€‚`Next.js`+`Apollo Server 4`ã®æ–¹ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ã‚‚å¤šã„ã®ã§ã™ãŒã€`multipart/form-data`ã«ãã¡ã‚“ã¨å¯¾å¿œã—ã¦ã„ãªã„ã‚‚ã®ã°ã‹ã‚Šãªã®ã§æ°—ã‚’ã¤ã‘ã¦ãã ã•ã„ã€‚

```ts
import { promises as fs } from "fs";
import { All, Controller, Req, Res } from "@nestjs/common";
import { ApolloServer } from "@apollo/server";
import {
  executeHTTPGraphQLRequest,
  FormidableFile,
  Raw,
  Request,
  Response,
} from "@node-libraries/nest-apollo-server";

export const typeDefs = `
  # Return date
  scalar Date
  type Query {
    date: Date!
  }

  # Return file information
  type File {
    name: String!
    type: String!
    value: String!
  }
  scalar Upload
  type Mutation {
    upload(file: Upload!): File!
  }
`;

export const resolvers = {
  Query: {
    date: async () => {
      await new Promise((resolve) => setTimeout(resolve, 500));
      return new Date();
    },
  },
  Mutation: {
    upload: async (_context, { file }: { file: FormidableFile }) => {
      return {
        name: file.originalFilename,
        type: file.mimetype,
        value: await fs.readFile(file.filepath, { encoding: "utf8" }),
      };
    },
  },
};

const apolloServer = new ApolloServer({
  typeDefs,
  resolvers,
});

apolloServer.start();

@Controller("/graphql")
export class GraphqlController {
  @All()
  async graphql(@Req() req: Request, @Res() res: Response) {
    await executeHTTPGraphQLRequest({
      req,
      res,
      apolloServer,
      context: async () => ({ req: Raw(req), res: Raw(res) }),
      options: {
        //Maximum upload file size set at 10 MB
        maxFileSize: 10 * 1024 * 1024,
      },
    });
  }
}
```

### StudioSandbox ã§ã®å‹•ä½œç¢ºèª

`yarn start:dev`ã§èµ·å‹•ã•ã›ãŸã‚‰ãƒ–ãƒ©ã‚¦ã‚¶ã§ä»¥ä¸‹ã® URL ã‚’é–‹ãã¾ã™ã€‚

<http://localhost:3000/graphql>

Apollo ã® StudioSandbox ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
![](/images/4160c573a7e02c/2023-01-27-16-11-27.png)

# ä»Šå›ä½¿ã£ãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«é–¢ã—ã¦

`Apollo Server 4`ã‚’ä½¿ç”¨ã™ã‚‹ã«å½“ãŸã£ã¦ã€NestJS ã¨ã‚„ã‚Šã¨ã‚Šã™ã‚‹éƒ¨åˆ†ã‚’ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åŒ–ã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚„ Express ã¨ Fastify ã®å·®ç•°ã‚’å¸åã™ã‚‹ã‚ˆã†ã«ä½œã£ã¦ã‚ã‚Šã¾ã™ã€‚Nest.js ç”¨ã«ã‚‚ä¼¼ãŸã‚ˆã†ãªã‚‚ã®ã‚’ä½œã£ã¦ã„ã¾ã™ã€‚

@node-libraries/nest-apollo-server

ã‚½ãƒ¼ã‚¹ã‚’è¼‰ã›ã¦ãŠãã¾ã™ã€‚

```ts
import { promises as fs } from "fs";
import { parse } from "url";
import formidable from "formidable";
import {
  ApolloServer,
  BaseContext,
  ContextThunk,
  GraphQLRequest,
  HeaderMap,
  HTTPGraphQLRequest,
} from "@apollo/server";
import { IncomingMessage, ServerResponse } from "http";

export type Request = IncomingMessage | { raw: IncomingMessage };
export type Response = ServerResponse | { raw: ServerResponse };

/**
 * Request parameter conversion options
 */
export type FormidableOptions = formidable.Options;

/**
 * File type used by resolver
 */
export type FormidableFile = formidable.File;

/**
 * Convert Requests and Responses for compatibility between Express and Fastify
 */
export const Raw = <T extends IncomingMessage | ServerResponse>(
  req: T | { raw: T }
) => ("raw" in req ? req.raw : req);

/**
 * Converting NextApiRequest to Apollo's Header
 * Identical header names are overwritten by later values
 * @returns Header in Map format
 */
export const createHeaders = (req: IncomingMessage): HeaderMap =>
  new HeaderMap(
    Object.entries(req.headers).flatMap<[string, string]>(([key, value]) =>
      Array.isArray(value)
        ? value.flatMap<[string, string]>((v) => (v ? [[key, v]] : []))
        : value
        ? [[key, value]]
        : []
    )
  );

/**
 *  Retrieve search from NextApiRequest
 * @returns search
 */
export const createSearch = (req: IncomingMessage) =>
  parse(req.url ?? "").search ?? "";

/**
 * Make GraphQL requests multipart/form-data compliant
 * @returns [body to be set in executeHTTPGraphQLRequest, function for temporary file deletion]
 */
export const createBody = (
  req: IncomingMessage,
  options?: formidable.Options
) => {
  const form = formidable(options);
  return new Promise<[GraphQLRequest, () => void]>((resolve, reject) => {
    form.parse(req, async (error, fields, files) => {
      if (error) {
        reject(error);
      } else if (!req.headers["content-type"]?.match(/^multipart\/form-data/)) {
        resolve([
          fields,
          () => {
            //
          },
        ]);
      } else {
        if (
          "operations" in fields &&
          "map" in fields &&
          typeof fields.operations === "string" &&
          typeof fields.map === "string"
        ) {
          const request = JSON.parse(fields.operations);
          const map: { [key: string]: [string] } = JSON.parse(fields.map);
          Object.entries(map).forEach(([key, [value]]) => {
            value.split(".").reduce((a, b, index, array) => {
              if (array.length - 1 === index) a[b] = files[key];
              else return a[b];
            }, request);
          });
          const removeFiles = () => {
            Object.values(files).forEach((file) => {
              if (Array.isArray(file)) {
                file.forEach(({ filepath }) => {
                  fs.rm(filepath);
                });
              } else {
                fs.rm(file.filepath);
              }
            });
          };
          resolve([request, removeFiles]);
        } else {
          reject(Error("multipart type error"));
        }
      }
    });
  });
};

/**
 * Creating methods
 * @returns method string
 */
export const createMethod = (req: IncomingMessage) => req.method ?? "";

/**
 * Execute a GraphQL request
 */
export const executeHTTPGraphQLRequest = async <Context extends BaseContext>({
  req: reqSrc,
  res: resSrc,
  apolloServer,
  options,
  context,
}: {
  req: Request;
  res: Response;
  apolloServer: ApolloServer<Context>;
  context: ContextThunk<Context>;
  options?: FormidableOptions;
}) => {
  const req = Raw(reqSrc);
  const res = Raw(resSrc);
  const [body, removeFiles] = await createBody(req, options);
  try {
    const httpGraphQLRequest: HTTPGraphQLRequest = {
      method: createMethod(req),
      headers: createHeaders(req),
      search: createSearch(req),
      body,
    };
    const result = await apolloServer.executeHTTPGraphQLRequest({
      httpGraphQLRequest,
      context,
    });
    res.statusCode = result.status ?? 200;
    result.headers.forEach((value, key) => {
      res.setHeader(key, value);
    });
    if (result.body.kind === "complete") {
      res.end(result.body.string);
    } else {
      for await (const chunk of result.body.asyncIterator) {
        res.write(chunk);
      }
      res.end();
    }
    return result;
  } finally {
    removeFiles();
  }
};
```

# ã¾ã¨ã‚

`Apollo Server 4`ã«å¯¾ã™ã‚‹ NestJS ã®å…¬å¼å¯¾å¿œãŒé–“ã«åˆã£ã¦ã¾ã›ã‚“ã€‚ã—ã‹ã—å¯¾å¿œãŒç„¡ã‹ã£ãŸã¨ã—ã¦ã‚‚ã€ã‚„ã‚‹ã¹ãäº‹ã¯å¿…è¦ãªã‚„ã‚Šã¨ã‚Šã‚’æ¥ç¶šã™ã‚‹ã ã‘ãªã®ã§ã€å¤§ã—ã¦é›£ã—ãã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

å†’é ­ã§ã‚‚æ›¸ãã¾ã—ãŸãŒ`Apollo Server 3`ã¯éæ¨å¥¨ãªã®ã§ã€æ—©ã€…ã«`Apollo Server 4`ã«ç§»è¡Œã—ã¾ã—ã‚‡ã†ã€‚
