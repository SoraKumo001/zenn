---
title: "Next.jsã§Web-Workerã‹ã‚‰Web-Assemblyå‘¼ã³å‡ºã™"
emoji: "ğŸª”"
type: "tech"
topics: ["nextjs", "react", "typescript", "wasm", "rust"]
published: true
---

# Web-Workerã¨Web-Assemblyã®é€£æºã«é–¢ã—ã¦

Web-Workerã‚’ä½¿ãˆã°ã€ä¸¦åˆ—åŒ–ã«ã‚ˆã‚‹æ©æµã§ç·åˆçš„ãªå‹•ä½œé€Ÿåº¦ã®å‘ä¸ŠãŒè¦‹è¾¼ã‚ã¾ã™
å¯¾ã—ã¦Web-Assemblyã‚’ä½¿ãˆã°ã€æ¼”ç®—é€Ÿåº¦ã®ã‚ˆã†ãªç›´åˆ—çš„ãªå‘ä¸ŠãŒè¦‹è¾¼ã‚ã¾ã™
ãªã‚‰ã°ã€ŒäºŒã¤ã‚’åˆã‚ã›ã‚Œã°ã€ã•ã‚‰ãªã‚‹ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚¢ãƒƒãƒ—ãŒè¦‹è¾¼ã‚ã‚‹ã€ã¨ã„ã†ã®ã¯èª°ã§ã‚‚æ€ã†ã“ã¨ã§ã—ã‚‡ã†

ã—ã‹ã—ã“ã®äºŒã¤ã®æŠ€è¡“ã€ã„ã–ä½¿ãŠã†ã¨ã™ã‚‹ã¨ãã‚Œãªã‚Šã«é¢å€’ã§æ•·å±…ãŒé«˜ãæ„Ÿã˜ã¾ã™
ãã®è¾ºã‚Šã‚’ç°¡å˜ã«å®Ÿç¾ã™ã‚‹ãŸã‚ã®æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™

# ã‚µãƒ³ãƒ—ãƒ«ç½®ãå ´

<https://github.com/SoraKumo001/next-worker3>
<https://next-worker3.vercel.app/>

![å‹•ä½œç”»é¢](/images/5b031d682d3fe2/20210827-WebWorker3.gif)

# é–¢é€£è¨˜äº‹

[Next.jsã§Web-Workerã‚’å‘¼ã³å‡ºã™](https://zenn.dev/sora_kumo/articles/65420761a0bec2)
[Next.jsã§ãŠæ‰‹è»½ã«Web-Workerã‚’å‘¼ã³å‡ºã™](https://zenn.dev/sora_kumo/articles/bb10104c12080e)
[Next.jsã¨Rustã®TypeScriptãªWebAssemblyç”Ÿæ´»](https://qiita.com/SoraKumo/items/d68b78bedda91ff08435)

# äº‹å‰æº–å‚™

## Rust

### ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

<https://www.rust-lang.org/tools/install>
ã“ã‚ŒãŒç„¡ã„ã¨è©±ã«ãªã‚‰ãªã„ã®ã§ã€ã¾ãšã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™

### wasm-packã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¦wasm-packå…¥ã‚Œã‚‹ã¨Rustã§WebAssemblyãŒç°¡å˜ã«ç”Ÿæˆã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™
`cargo install wasm-pack`

### Rustã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®æº–å‚™

ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã¯Next.jsã¨å…±æœ‰ã™ã‚‹å½¢ã«ã—ã¾ã™

- rust/Cargo.toml

```toml
[package]
name = "rust_sums"
version = "1.0.0"
edition = "2018"
[lib]
crate-type = ["cdylib"]
[dependencies]
wasm-bindgen = "0.2.76"
```

### 1ï½ä»»æ„ã®æ•°ã®åˆè¨ˆã‚’å‡ºã™ã‚³ãƒ¼ãƒ‰

- rust/src/lib.rs

```rust
use wasm_bindgen::prelude::*;
#[wasm_bindgen]
pub fn sums(value: i64) -> i64 {
    let mut a: i64 = 0;
    for i in 1..value + 1 {
        a += i;
    }
    a
}
```

### ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«

`src/libs/wasm`ã®ä¸­ã«ãƒ“ãƒ«ãƒ‰ã—ãŸwasmãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡ºåŠ›ã—ã¾ã™

```bash
wasm-pack build rust -d ../src/libs/wasm
```

## Next.js

### ç’°å¢ƒã‚’æ•´ãˆã‚‹

å¿…è¦æœ€ä½é™ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™

```bash
yarn init -y
yarn add next react react-dom
yarn add -D typescript @types/node @types/react
```

Next.jsã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰WebPackã®configã«`asyncWebAssembly`ã‚’åŠ ãˆã¾ã™ã€‚ã“ã‚Œã§Web-AssemblyãŒä½¿ç”¨å¯èƒ½ã¨ãªã‚Šã¾ã™
Web-Workerã«é–¢ã—ã¦ã¯ã€ç‰¹ã«è¿½åŠ è¨­å®šã¯ã„ã‚Šã¾ã›ã‚“

- next.config.js

```js
/**
 * @type { import("next").NextConfig}
 */
const config = {
  webpack: (config) => ({
    ...config, experiments: {
      asyncWebAssembly: true
    }
  })
};
module.exports = config;
```

### Web-Workerã®ä½œæˆ

- src/libs/worker-test.ts

Web-Workerã‹ã‚‰wasmã‚’å‘¼ã³å‡ºã™é–¢æ•°ã¨ã€æ™®é€šã«JavaScriptã§å®Ÿè¡Œã™ã‚‹é–¢æ•°ã®äºŒç¨®é¡ã‚’ç”¨æ„ã—ã¦ã„ã¾ã™

```ts
import { initWorker } from "worker-lib";
import { sums } from './wasm/rust_sums_bg'

const sums_wasm = (count: number) => {
  return Number(sums(BigInt(count)))
}
const sums_javascript = (count: number) => {
  let a = BigInt(0);
  for (let i = BigInt(1); i <= count; i++) {
    a += i
  }
  return Number(a)
}

// Initialization process to make it usable in Worker.
const map = initWorker({ sums_wasm, sums_javascript })
// Export only the type
export type WorkerTest = typeof map
```

### Next.jsã®ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã®ä½œæˆ

ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨Web-Workerä¸Šã‹ã‚‰wasmã¨JavaScriptã®é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¾ã™
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§1ï½1å„„ã®åˆè¨ˆã‚’è¨ˆç®—ã—ã¾ã™

- src/pages/index.tsx

```tsx
import { useState } from "react";
import { createWorker } from "worker-lib";
import type { WorkerTest } from "../libs/worker-test";

// Create an instance to execute the Worker
// execute("function name",... parameter) to start the Worker
const execute = createWorker<WorkerTest>(
  () => new Worker(new URL("../libs/worker-test", import.meta.url)),
  5 // Maximum parallel number
);

const Page = () => {
  const [values, setValues] = useState<(number | string)[]>([]);
  const [a, setA] = useState(100000000);
  return (
    <div>
      <form>
        <input name="a" value={a} onChange={(e) => setA(Number(e.currentTarget.value))} />
        <button
          type="button"
          onClick={async () => {
            const index = values.length;
            setValues([...values, "running"]);
            //Calling a Worker
            const result = await execute("sums_wasm", a);
            setValues((values) => values.map((v, i) => (i === index ? result : v)));
          }}
        >
          wasm
        </button>
        <button
          type="button"
          onClick={async () => {
            const index = values.length;
            setValues([...values, "running"]);
            //Calling a Worker
            const result = await execute("sums_javascript", a);
            setValues((values) => values.map((v, i) => (i === index ? result : v)));
          }}
        >
          JavaScript
        </button>
      </form>
      {values.map((v, index) => (
        <div key={index}>{v}</div>
      ))}
    </div>
  );
};
export default Page;
```

# å‹•ä½œç¢ºèª

- ã‚³ãƒãƒ³ãƒ‰  

```bash
yarn next
```

# ã¾ã¨ã‚

æ¯”è¼ƒçš„ç°¡å˜ã«Web-Workerã¨Web-Assemblyã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ãŒå‡ºæ¥ã¾ã—ãŸ
ã“ã‚Œã«ã‚ˆã£ã¦ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ã¶ã‚“å›ã—CPUãƒªã‚½ãƒ¼ã‚¹ã‚’é™ç•Œã¾ã§ä½¿ã„åˆ‡ã‚‹ã“ã¨ãŒå‡ºæ¥ã‚‹ã¨æ€ã‚ã‚Œã¾ã™ãŒã€ä¸€ä½“ä½•ã«ä½¿ã†ã®ã‹ã•ã£ã±ã‚Šæ€ã„ã¤ãã¾ã›ã‚“
