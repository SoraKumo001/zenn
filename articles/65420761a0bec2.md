---
title: "Next.jsã§Web-Workerã‚’å‘¼ã³å‡ºã™"
emoji: "ğŸª”"
type: "tech"
topics: ["nextjs", "react", "typescript", "webworker"]
published: true
---

# Next.jsã¨Web-Worker

Next.jsã¯æ§˜ã€…ãªæ©Ÿèƒ½ã‚’ç„¡è¨­å®šã§è¡Œãˆã‚‹ã‚ˆã†ã«é–‹ç™ºã•ã‚Œã¦ã„ã¾ã™
Web-Workerã«é–¢ã—ã¦ã‚‚åŒæ§˜ã§ã€next.config.jsã«ä¸€åˆ‡æ‰‹ã‚’å…¥ã‚Œãšã«å‹•ã‹ã™ã“ã¨ãŒå‡ºæ¥ã¾ã™
ã©ã®ãã‚‰ã„æ‰‹è»½ã«åˆ©ç”¨å¯èƒ½ã‹ã€è©¦ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™

# ã‚µãƒ³ãƒ—ãƒ«ç½®ãå ´

<https://github.com/SoraKumo001/next-worker>
<https://next-worker.vercel.app/>

# åˆæœŸä½œæ¥­

```sh
yarn add next react react-dom
yarn add -D typescript @types/node @types/react
```

# ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰

- src/libs/sums.ts

1ã‹ã‚‰countã§ä¸ãˆã‚‰ã‚ŒãŸæ•°ã¾ã§ã®åˆè¨ˆã‚’å‡ºã™ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§ã™
è² è·ã‚’ã‹ã‘ã‚‹ãŸã‚ä½œæ¥­ã‚’1000å›ç¹°ã‚Šè¿”ã—ã€æœ€å¾Œã®çµæœã‚’è¿”ã—ã¾ã™

```ts
export default null; //TypeScriptè­¦å‘Šé¿ã‘

const worker = self as unknown as Worker;
worker.addEventListener("message", ({ data: { count } }: MessageEvent<{ count: number }>) => {
  let a: number;
  for (let j = 0; j < 1000; j++) {
    a = 0;
    for (let i = 1; i <= count; i++) {
      a += i;
    }
  }
  worker.postMessage({ value: a });
});
```

- src/pages/index.tsx

å®Ÿè¡Œãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã”ã¨ã«Web-Workerã‚’èµ·å‹•ã—ã¦ã€çµæœãŒè¿”ã£ã¦ããŸã‚‰è¡¨ç¤ºã‚’æ›´æ–°ã—ã¾ã™

```tsx
import { useState } from "react";

const Page = () => {
  const [values, setValues] = useState([]);
  const handleSubmit: React.FormEventHandler<HTMLFormElement> = (e) => {
    e.preventDefault();
    const index = values.length;
    setValues([...values, "å®Ÿè¡Œä¸­"]);
    //web-workerã®å‘¼ã³å‡ºã—
    const worker = new Worker(new URL("../libs/sums", import.meta.url));
    worker.addEventListener("message", ({ data: { value } }) => {
      setValues((values) => values.map((v, i) => (i === index ? value : v)));
    });
    worker.postMessage({ count: parseInt(e.currentTarget["count"].value) });
  };
  return (
    <div>
      <form onSubmit={handleSubmit}>
        <input name="count" defaultValue="1000000" />
        <button>å®Ÿè¡Œ</button>
      </form>
      {values.map((v, index) => (
        <div key={index}>{v}</div>
      ))}
    </div>
  );
};

export default Page;
```

# å®Ÿè¡Œ

```sh
yarn next
```

![](https://storage.googleapis.com/zenn-user-upload/eb9ec9abbe9d89665359b881.gif)

ã“ã®å‡¦ç†ã‚’æ™®é€šã«è¡Œã†ã¨è¨ˆç®—ä¸­ã¯UIãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã™ãŒã€Web-Workerã‚’åˆ©ç”¨ã—ãŸå ´åˆã‚¹ãƒ ãƒ¼ã‚ºã«å‹•ãã¾ã™

# ã¾ã¨ã‚

ãƒ‡ãƒ¼ã‚¿ã®ã‚„ã‚Šã¨ã‚Šã«postMessageã‚’ä»‹ã™ã“ã¨ã«ãªã‚‹ã®ã§ã€å¤šå°‘å›ã‚Šãã©ã„éƒ¨åˆ†ãŒã‚ã‚Šã¾ã™ãŒã€ã‚µãƒ¼ãƒã¨é€šä¿¡ã™ã‚‹ã®ã¨æ„Ÿè¦šçš„ã«ã¯åŒã˜ã§ã™
ã¨ã¦ã‚‚ãŠæ‰‹è»½ã«åˆ©ç”¨å‡ºæ¥ã‚‹ã®ã§ã€ã¡ã‚‡ã£ã¨ã—ãŸé‡ã„å‡¦ç†ãŒã‚ã‚‹å ´åˆãªã©ã«åˆ©ç”¨ã—ã¦ã„ããŸã„ã¨ã“ã‚ã§ã™