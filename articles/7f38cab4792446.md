---
title: "React ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®çœŸã®ä½¿ã„æ–¹ï¼ˆuseContextï¼‰"
emoji: "ğŸ˜º"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [react,nextjs,typescript,context]
published: true
---

â€» ã‚¸ãƒ§ãƒ¼ã‚¯è¨˜äº‹ã§ã™
â€» ã‚¸ãƒ§ãƒ¼ã‚¯ã§ã™ãŒã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯ãã¡ã‚“ã¨å‹•ãã¾ã™

ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ https://github.com/SoraKumo001/next-context
å‹•ä½œç¢ºèª https://next-context-ten.vercel.app/

# ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«ã¤ã„ã¦

ä¸‹è¨˜ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¯ã“ã®ã‚ˆã†ã«èª¬æ˜ã•ã‚Œã¦ã„ã¾ã™ã€‚

> ã‚³ãƒ³ãƒ†ã‚¯ã‚¹ãƒˆã¯å„éšå±¤ã§æ‰‹å‹•ã§ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ä¸‹ã«æ¸¡ã™ã“ã¨ãªãã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ„ãƒªãƒ¼å†…ã§ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã™æ–¹æ³•ã‚’æä¾›ã—ã¾ã™ã€‚

ã¤ã¾ã‚Šã€ãƒ„ãƒªãƒ¼å†…ã§æœ‰åŠ¹ã¨ãªã‚‹ãƒ‡ãƒ¼ã‚¿é ˜åŸŸã§ã™ã€‚
ãã‚Œä»¥ä¸Šã‚’æœŸå¾…ã™ã‚‹ã¨æ®‹å¿µãªã“ã¨ã«ãªã‚‹ã®ã§ã€ã¨ã«ã‹ãã‚¿ãƒ€ã®ãƒ‡ãƒ¼ã‚¿é ˜åŸŸã ã¨æ€ã„ã¾ã—ã‚‡ã†ã€‚

https://ja.reactjs.org/docs/context.html

# ãªãœã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ä½¿ã†ã®ã‹

ãƒ„ãƒªãƒ¼å†…ã§ã‚¹ã‚³ãƒ¼ãƒ—ã‚’æŒã¤ãƒ‡ãƒ¼ã‚¿é ˜åŸŸãŒæ¬²ã—ã„ã‹ã‚‰ã§ã™ã€‚
ãã‚Œä»¥ä¸Šã®ã“ã¨ã‚’æœŸå¾…ã—ã¦ã¯ã„ã‘ã¾ã›ã‚“ã€‚

# ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®ä½¿ã„æ–¹

ï¼‘ï¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ä½œæˆã—ã€ç‹¬è‡ªã®ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ã‚’æ”¾ã‚Šè¾¼ã‚€
ï¼’ï¼æ”¹å¤‰ã—ãŸã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã«å€¤ã‚’æ¸¡ã™
ï¼“ï¼å‹æ‰‹ã«ä½œã£ãŸã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã§ãƒ‡ãƒ¼ã‚¿ã®ã‚„ã‚Šã¨ã‚Šã‚’ã™ã‚‹

ä»Šå›ã¯å…¬å¼ã«ã¯è¼‰ã£ã¦ã„ãªã„ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®ä½¿ã„æ–¹ã‚’èª¬æ˜ã—ã¾ã™ã€‚
è¡¨ç¤ºã•ã‚Œã‚‹ã®ã¯ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨å€¤ãŒå¢—ãˆã‚‹ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã§ã™ã€‚

## 1.ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’é­”æ”¹é€ ã™ã‚‹

### src/libs/context.ts

```tsx
import React, {
  Context,
  createContext,
  ReactNode,
  useContext,
  useEffect,
  useRef,
  useState
} from 'react'

type Manager<T> = {
  state: T
  dispatches: Set<Readonly<[React.Dispatch<React.SetStateAction<unknown>>, (state: T) => unknown]>>
}

type CustomContext<T> = {
  Provider: ({
    value,
    children
  }: {
    children: ReactNode
    value?: T
  }) => React.FunctionComponentElement<React.ProviderProps<Manager<T>>>
  _Provider: Context<Manager<T>>['Provider']
  Consumer: Context<T>['Consumer']
  displayName?: string | undefined
}

const createManager = <T>(state?: T) => ({
  state: state as T,
  dispatches: new Set<
    Readonly<[React.Dispatch<React.SetStateAction<unknown>>, (state: T) => unknown]>
  >()
})

const createCustomContext: {
  <T>(state: T): CustomContext<T>
  <T>(): CustomContext<T | undefined>
} = <T>(state?: T): CustomContext<T> => {
  const context = createContext<Manager<T>>(undefined as never)
  const customContext = context as unknown as CustomContext<T>
  customContext._Provider = context.Provider
  customContext.Provider = ({ value, children }: { children: ReactNode; value?: T }) => {
    const manager = useRef(createManager<T>(value || state)).current
    return React.createElement(customContext._Provider, { value: manager }, children)
  }
  return customContext
}

export const useSelector = <T, K>(context: CustomContext<T>, selector: (state: T) => K) => {
  const manager = useContext<Manager<T>>(context as unknown as Context<Manager<T>>)
  const [state, dispatch] = useState(() => selector(manager.state))
  useEffect(() => {
    const v = [dispatch as React.Dispatch<React.SetStateAction<unknown>>, selector] as const
    manager.dispatches.add(v)
    dispatch(selector(manager.state))
    return () => {
      manager.dispatches.delete(v)
    }
  }, [manager])
  return state
}
export const useDispatch = <T>(context: CustomContext<T>) => {
  const manager = useContext<Manager<T>>(context as unknown as Context<Manager<T>>)
  const { dispatches } = manager
  return (state: T | ((state: T) => T)) => {
    const newState = typeof state === 'function' ? (state as (state: T) => T)(manager.state) : state
    if (newState !== state) {
      manager.state = newState
      dispatches.forEach(([dispatch, selector]) => dispatch(selector(manager.state)))
    }
  }
}

export { createCustomContext as createContext }
```

`createContext`ã‚’æ”¹å¤‰ã—ã¦ã€`useSelector`ã¨`useDispatch`ã‚’ç”Ÿã¿å‡ºã—ã¾ã™ã€‚
ãƒ‡ãƒ¼ã‚¿æ§‹é€ ãŒé•ã†ã®ã§`Provider`ã«ã‚‚ä»‹å…¥ã—ã¦ã„ã¾ã™ã€‚

## 2.ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã«å€¤ã‚’æ¸¡ã—ã¦ã€ã¤ã„ã§ã«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚‚ä½œã‚‹

ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã§ã€å„ã‚¹ãƒ†ãƒ¼ãƒˆã‚’æ›´æ–°ã—ã¦ã„ã¾ã™

- src/pages/index.tsx

```tsx
import React from 'react'
import { createContext, useDispatch, useSelector } from '../libs/context'

const context = createContext({ a: 20, b: 100 })

const Component01 = () => {
  console.log('Component01')
  const a = useSelector(context, (v) => v.a)
  return <div>a:{a}</div>
}
const Component02 = () => {
  console.log('Component02')
  const b = useSelector(context, (v) => v.b)
  return <div>b:{b}</div>
}
const Component03 = () => {
  console.log('Component03')
  const dispatch = useDispatch(context)
  return (
    <div>
      <div>
        <button onClick={() => dispatch((v) => ({ ...v, a: v.a + 1 }))}>a</button>
        <button onClick={() => dispatch((v) => ({ ...v, b: v.b + 1 }))}>b</button>
      </div>
    </div>
  )
}

const Page = () => {
  return (
    <context.Provider>
      <Component01 />
      <Component02 />
      <Component03 />
    </context.Provider>
  )
}
export default Page
```

## 3.Component03ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™

a,bã®ãƒœã‚¿ãƒ³ã§ãã‚Œãã‚Œã®ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãŒå¢—åŠ ã—ã€console.logã«ã¯å¯¾è±¡ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåã®ã¿è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ã¤ã¾ã‚Šç„¡é§„ãªå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã¯èµ·ã“ã‚Šã¾ã›ã‚“ã€‚
é•ã†ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸéš›ã«ç›´å‰ã®å¤‰æ›´ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚‚ä¸€å›ã ã‘å†è©•ä¾¡ã•ã‚Œã¾ã™ãŒã€ä»•æ§˜ã§ã™ã€‚

https://next-context-ten.vercel.app/

![](/images/7f38cab4792446/01.gif)

æ°—åˆ†ã¯ã¾ã‚‹ã§Reduxï¼

ã‚ã‚Œï¼Ÿ

# å‚è€ƒè¨˜äº‹

ã“ã¡ã‚‰ã®è¨˜äº‹ã‚’å‚è€ƒã«æ›¸ã‹ã›ã¦ã„ãŸã ãã¾ã—ãŸ
ã“ã¡ã‚‰ã®æ–¹ãŒçœŸã£å½“ãªæ–¹æ³•ã§ã™

https://zenn.dev/hitoshiasano/articles/3aea56a6a8c0f7
